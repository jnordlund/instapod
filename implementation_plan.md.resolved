# Instapod — Implementeringsplan

Instapod är en Node.js/TypeScript-tjänst som automatiskt hämtar artiklar från Instapaper, översätter dem till konfigurerat språk via ett OpenAI-kompatibelt API, konverterar dem till mp3 via edge-tts, och publicerar dem som en podcast RSS-feed.

## User Review Required

> [!IMPORTANT]
> **Öppna frågor från PRD som påverkar implementeringen:**
> 1. **Instapaper API-access** — Har du redan API-nycklar (consumer key/secret) för Instapaper Full API, eller behöver vi ansöka?
> 2. **Arkivering i Instapaper** — Ska artiklar markeras som lästa/arkiverade efter konvertering?
> 3. **Chunkning av långa artiklar** — edge-tts hanterar vanligtvis upp till ~10 000 tecken bra. Ska vi chunka längre artiklar redan i v1, eller lämna det till P1?
> 4. **Språkdetektering** — Föreslår att vi använder ett lättviktsbibliotek (`franc-min`) för detektering. Ok?
> 5. **Översättning i ett anrop eller chunkad** — Föreslår max ~4 000 tokens per anrop med automatisk uppdelning. Ok?

---

## Projektstruktur

```
instapod/
├── src/
│   ├── index.ts              # Entry point — startar server + scheduler
│   ├── config.ts             # Laddar & validerar YAML-config
│   ├── instapaper.ts         # Instapaper OAuth 1.0a klient
│   ├── parser.ts             # HTML → rentext + metadata
│   ├── translator.ts         # Översättning via OpenAI-kompatibelt API
│   ├── tts.ts                # edge-tts wrapper (text → mp3)
│   ├── feed.ts               # RSS 2.0 + iTunes podcast feed generator
│   ├── server.ts             # Express HTTP-server
│   ├── scheduler.ts          # Cron-baserad schemaläggning
│   ├── state.ts              # JSON-fil-baserad state (deduplicering)
│   ├── worker.ts             # Pipeline-orkestrator
│   └── types.ts              # Delade TypeScript-typer
├── tests/
│   ├── config.test.ts
│   ├── parser.test.ts
│   ├── translator.test.ts
│   ├── feed.test.ts
│   ├── state.test.ts
│   └── worker.test.ts
├── config.example.yaml
├── Dockerfile
├── docker-compose.yaml
├── package.json
├── tsconfig.json
└── README.md
```

---

## Proposed Changes

### 1. Projektskelett

#### [NEW] [package.json](file:///Users/jnordlund/Dev/instapod/package.json)
- Dependencies: `express`, `node-cron`, `js-yaml`, `edge-tts` (npm-paket), `franc-min`, `html-to-text`, `oauth-1.0a`
- DevDependencies: `typescript`, `@types/node`, `@types/express`, `vitest`, `tsx`
- Scripts: `dev`, `build`, `start`, `test`

#### [NEW] [tsconfig.json](file:///Users/jnordlund/Dev/instapod/tsconfig.json)
- Target ES2022, module NodeNext, strict mode

---

### 2. Config-modul

#### [NEW] [src/config.ts](file:///Users/jnordlund/Dev/instapod/src/config.ts)
- Laddar `config.yaml` från konfigurerbar sökväg (env `CONFIG_PATH`, default `/data/config.yaml`)
- Validerar alla obligatoriska fält med tydliga felmeddelanden
- Env-variabler kan overrida config-värden (t.ex. `INSTAPAPER_CONSUMER_KEY`)
- Exporterar typad `AppConfig`-interface

#### [NEW] [config.example.yaml](file:///Users/jnordlund/Dev/instapod/config.example.yaml)
- Exempelkonfiguration baserad på PRD

---

### 3. Instapaper-klient

#### [NEW] [src/instapaper.ts](file:///Users/jnordlund/Dev/instapod/src/instapaper.ts)
- OAuth 1.0a-signering med `oauth-1.0a` + `crypto`
- xAuth-inloggning (Instapaper använder xAuth för access token)
- `getBookmarks(folderId?)` — hämtar bokmärken, filtrerar på taggar
- `getBookmarkText(bookmarkId)` — hämtar artikelns HTML-text
- `listFolders()` — listar mappar/taggar
- Cachar access token i minnet under processens livstid

---

### 4. Artikelparser

#### [NEW] [src/parser.ts](file:///Users/jnordlund/Dev/instapod/src/parser.ts)
- Konverterar HTML → ren text med `html-to-text`
- Extraherar title, author/source, body
- Bygger intro-text: *"En artikel från [källa]. [Titel]."*
- Returnerar `ParsedArticle`-typ

---

### 5. Översättningsmodul

#### [NEW] [src/translator.ts](file:///Users/jnordlund/Dev/instapod/src/translator.ts)
- Anropar `POST {api_base}/chat/completions` med systemmeddelande för översättning
- Chunkar text vid >4 000 tokens (enkel teckenbaserad uppdelning vid meningsgränser)
- Språkdetektering med `franc-min` — hoppar över översättning om redan target_language
- Returnerar översatt text (titel + body)
- Hanterar rate limits med exponentiell backoff

---

### 6. TTS-modul

#### [NEW] [src/tts.ts](file:///Users/jnordlund/Dev/instapod/src/tts.ts)
- Wrapper runt `edge-tts` npm-paketet (eller CLI-fallback)
- `synthesize(text, outputPath, voice, rate?, pitch?)`
- Hanterar långa texter genom att chunka vid meningsgränser och konkatenera mp3-filer
- Returnerar duration i sekunder (via mp3-metadata)

---

### 7. RSS Feed Generator

#### [NEW] [src/feed.ts](file:///Users/jnordlund/Dev/instapod/src/feed.ts)
- Genererar valid RSS 2.0 XML med iTunes-namespace
- Läser metadata från state (processade artiklar med titel, duration, pubDate)
- Sätter `enclosure`-URL baserat på `config.server.base_url`
- Uppdateras varje gång en ny artikel processats

---

### 8. HTTP-server

#### [NEW] [src/server.ts](file:///Users/jnordlund/Dev/instapod/src/server.ts)
- `GET /feed` — returnerar RSS XML (`Content-Type: application/rss+xml`)
- `GET /audio/:filename` — serverar mp3-filer från `data_dir/audio/`
- `POST /trigger` — startar en pipeline-körning manuellt
- `GET /health` — returnerar `{ status: "ok", lastRun: "..." }` (P1 men lätt att inkludera direkt)

---

### 9. Scheduler

#### [NEW] [src/scheduler.ts](file:///Users/jnordlund/Dev/instapod/src/scheduler.ts)
- Använder `node-cron` med cron-uttryck från config
- Anropar worker vid varje tick
- Guard mot concurrent runs (mutex/flag)

---

### 10. State/Deduplicering

#### [NEW] [src/state.ts](file:///Users/jnordlund/Dev/instapod/src/state.ts)
- Läser/skriver `state.json` i `data_dir`
- Lagrar: `processedBookmarks` (map av bookmark_id → metadata), `lastRun` timestamp
- Metadata per artikel: `bookmarkId`, `title`, `source`, `filename`, `duration`, `pubDate`
- Atomisk skrivning (write to temp → rename)

---

### 11. Worker Pipeline

#### [NEW] [src/worker.ts](file:///Users/jnordlund/Dev/instapod/src/worker.ts)
- Orkestrator som kopplar ihop alla moduler:
  1. Hämta bokmärken via Instapaper
  2. Filtrera bort redan processade (via state)
  3. Filtrera på taggar (om konfigurerat)
  4. För varje ny artikel:
     a. Hämta HTML-text → Parsa → `ParsedArticle`
     b. Detektera språk → översätt om nödvändigt
     c. Bygg intro + body → TTS → mp3
     d. Uppdatera state
  5. Regenerera RSS-feed
- Begränsad concurrency (2 artiklar samtidigt)
- Fångar och loggar fel per artikel utan att avbryta hela körningen

---

### 12. Entry Point & Docker

#### [NEW] [src/index.ts](file:///Users/jnordlund/Dev/instapod/src/index.ts)
- Ladda config → initiera state → starta HTTP-server → starta scheduler

#### [NEW] [Dockerfile](file:///Users/jnordlund/Dev/instapod/Dockerfile)
- Base: `node:20-slim`, installera edge-tts (Python + pip), multi-stage build

#### [NEW] [docker-compose.yaml](file:///Users/jnordlund/Dev/instapod/docker-compose.yaml)
- Service med volymmontering, port-mapping, config-fil

---

### 13. Typer

#### [NEW] [src/types.ts](file:///Users/jnordlund/Dev/instapod/src/types.ts)
- `AppConfig`, `ParsedArticle`, `ProcessedBookmark`, `AppState`, etc.

---

## Implementeringsordning

```mermaid
graph LR
  A[1. Skelett & Config] --> B[2. Types & State]
  B --> C[3. Parser]
  B --> D[4. Translator]
  B --> E[5. TTS]
  C --> F[6. Instapaper Client]
  D --> G[7. Worker Pipeline]
  E --> G
  F --> G
  G --> H[8. RSS Feed]
  H --> I[9. HTTP Server]
  I --> J[10. Scheduler & Entry Point]
  J --> K[11. Docker]
```

Modulerna 3–5 kan byggas parallellt. Worker-pipelinen kopplar ihop allt.

---

## Verification Plan

### Automatiserade tester (Vitest)

Kör alla tester med:
```bash
cd /Users/jnordlund/Dev/instapod && npm test
```

| Testfil | Vad den testar |
|---------|----------------|
| `parser.test.ts` | HTML → ren text, intro-generering, edge cases (tom HTML, bara rubriker) |
| `translator.test.ts` | Mockat API-anrop, chunkning av lång text, skip om samma språk |
| `feed.test.ts` | Valid RSS 2.0 XML-output, korrekt iTunes-namespace, enclosure-URLs |
| `state.test.ts` | Läs/skriv, deduplicering, atomisk skrivning |
| `config.test.ts` | Validering, defaults, env-override |
| `worker.test.ts` | Pipeline-flöde med mockade moduler, felhantering per artikel |

### Manuell verifiering

1. **Starta lokalt** — `npm run dev` med en giltig `config.yaml`. Kontrollera att servern startar utan fel.
2. **Trigga manuellt** — `curl -X POST http://localhost:8080/trigger` och verifiera att artiklar processas.
3. **Hämta feed** — `curl http://localhost:8080/feed` och validera XML-output i en podcast-validator (t.ex. [Podbase](https://podba.se/validate/)).
4. **Lyssna** — Lägg till feed-URL i en podcast-app och verifiera att avsnitt syns och kan spelas.
5. **Docker** — `docker build -t instapod . && docker run -v ./data:/data -p 8080:8080 instapod` — verifiera samma beteende.

> [!NOTE]
> Manuella steg 2–4 kräver giltiga Instapaper-credentials och en OpenAI API-nyckel. Om dessa inte finns tillgängliga direkt kan vi initialt testa med mockad data.
